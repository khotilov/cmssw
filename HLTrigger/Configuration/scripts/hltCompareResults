#! /bin/bash

function log() {
  echo -e "$@"
}

function err() {
  echo -e "$@" 1>&2
}


# exract list of triggers
TRIGGERS=$(cat hlt.py | grep 'cms.Path' | sed -e's/process.\(\w\+\) = cms.Path.*/\1/')

# check if thw menu as a whole was run
if ! [ -f "hlt.done" ]; then
  err "Execution of the full HLT men failed.\nPlease check the contents of 'hlt.log' for details."
  exit 1
fi

# compare the results of running each path by iteslf with those from the full menu
STATUS=0
for TRIGGER in $TRIGGERS; do
  if ! [ -f ${TRIGGER}.done ]; then
    err "Execution of the trigger $TRIGGER failed.\nPlease check the contents of '$TRIGGER.log' for details."
    STATUS=1
    continue
  fi
  RESULT=$(cat "hlt.log"      | awk "/TrigReport ---------- Modules in Path: $TRIGGER ------------/"'{ while ($1 == "TrigReport") { print; getline; } }' | sed -e's|TrigReport     1 ....|TrigReport     1 xxxx|')
  SINGLE=$(cat "$TRIGGER.log" | awk "/TrigReport ---------- Modules in Path: $TRIGGER ------------/"'{ while ($1 == "TrigReport") { print; getline; } }' | sed -e's|TrigReport     1 ....|TrigReport     1 xxxx|')
  if [ "$RESULT" != "$SINLGE" ]; then
    err "Inconsitencies found comparing the result of the trigger $TRIGGER run as part of the whole menu, or standalone.\nPlease compare the contents of 'hlt.log' and '$TRIGGER.log' for details."
    STATUS=1
  fi
done

exit $STATUS
