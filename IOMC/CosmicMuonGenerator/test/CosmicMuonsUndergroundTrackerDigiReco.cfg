process Reco = {
    untracked PSet configurationMetadata = {
	untracked string version = "$Revision$"
	untracked string name = "$Source$"
	untracked string annotation = "cosmics in tracker: digi+reco"
    }

    # initialize  MessageLogger
    include "FWCore/MessageLogger/data/MessageLogger.cfi"
    
    # Monitor
    untracked PSet options = {
	untracked bool wantSummary = true
    }

#    service = RandomNumberGeneratorService {
#	PSet moduleSeeds = {
#	    untracked uint32 mix = 3456
#	}
#    }

    source = PoolSource {
	untracked int32 maxEvents   = -1
	untracked uint32 skipEvents = 0
	untracked vstring fileNames = {
	    "file:cosmics_sim.root"
	}
    }

#
# Includes for digi step:
#
    # Need to avoid default pixel digi, but want to run same module name siPixelDigis.
    # Therefore all following includes come (indirectly) from
    #    include "Configuration/StandardSequences/data/Simulation.cff"
    include "SimGeneral/TrackingAnalysis/data/trackingtruth.cfi"
    include "Geometry/TrackerGeometryBuilder/data/trackerGeometry.cfi"
    #include "SimTracker/SiPixelDigitizer/data/PixelDigi.cfi"
    # Accordnig to https://hypernews.cern.ch/HyperNews/CMS/get/pixelOfflineSW/92/1/1/1/1.html,
    # PixelDigi.cfi replaced by the following to add untracked parameter
    # (Take care: Must follow change in >CMSSW_1_3_4!):
    module siPixelDigis =  SiPixelDigitizer { 
	vstring ROUList = {
	    "TrackerHitsPixelBarrelLowTof","TrackerHitsPixelBarrelHighTof",
	    "TrackerHitsPixelEndcapLowTof","TrackerHitsPixelEndcapHighTof"}
	double ElectronPerAdc=135.0
	double ThresholdInNoiseUnits = 5.
        double TanLorentzAnglePerTesla =0.106
        int32 AddPixelInefficiency = 0	
        bool AddNoise = true
        bool AddNoisyPixels = true
        bool MissCalibrate = true
        double GainSmearing = 0.0
        double OffsetSmearing = 0.0
        double NoiseInElectrons =500.0
        bool  Alpha2Order = true
	
	# Mean tof in pixel is 30, but there is no shift possible. The readout window is 
	# by default 12.5 ns. But I extend here above 42.5 since I loose a lot of pixel hits
	# otherwise. Detailed studies about that postponed...
	untracked double TofCut = 70.
    }
    include "SimTracker/SiStripDigitizer/data/SiStripDigi.cfi" 
    sequence trDigi = { siPixelDigis & siStripDigis }

    include "Configuration/StandardSequences/data/MixingNoPileUp.cff" 

#
# Adjustments for digitisation:
#
    # block SiStripNoiseServiceParameters used in siStripDigis AND siStripClusters
    replace SiStripNoiseServiceParameters.PeakMode = true
    replace siStripDigis.APVpeakmode = true # for SiStripDigitizerAlgorithm/SiLinearChargeDivider
    replace siStripDigis.CouplingCostant  = {0.86,0.07}
    replace siStripDigis.CosmicDelayShift = 30.

#
# Includes for local tracker reco
#
    include "RecoLocalTracker/Configuration/data/RecoLocalTracker.cff"
    # Should be default, at least as long as we have in include 
    # SiStripClusterizer_SimData.cfi and not SiStripClusterizer_RealData.cfi:
    #    replace siStripClusters.ChannelThreshold    = 2.0
    #    replace siStripClusters.SeedThreshold       = 3.0
    #    replace siStripClusters.ClusterThreshold    = 5.0
    # Peak mode already chosen via SiStripNoiseServiceParameters.

    # no changes for pixel clustering

#
# Includes for cosmic track finding (other track finders are not ready for cosmics at P5)
#
    include "RecoTracker/SingleTrackPattern/data/CosmicTrackFinder.cff"
    replace cosmictrackfinder.GeometricStructure  = "STANDARD" # to use pixel  

#
# Event output
#
    include "Configuration/EventContent/data/EventContent.cff"
    replace FEVTSIMEventContent.outputCommands += "keep *_source_*_*"
    replace FEVTSIMEventContent.outputCommands += "keep *_cosmicseedfinder_*_*"
    replace FEVTSIMEventContent.outputCommands += "keep *_cosmictrackfinder_*_*"
    module FEVTSIM = PoolOutputModule { 
	using FEVTSIMEventContent
	untracked string fileName = 
	    "file:cosmics_sim_digi_reco.root"
        untracked PSet datasets = {
	    untracked PSet dataset1 = {
		untracked string dataTier = "GEN-SIM-DIGI-RECO" 
	    }
        }
    }
    
    #
    # Order of execution: Apart from GEANT restrict to tracker.
    #
    endpath p  = {
	mix, trDigi, trackingtruth, # digi only tracker
	trackerlocalreco, # local reco only in tracker
	cosmicseedfinder, cosmictrackfinder, # only cosmic track finder
	FEVTSIM}
}
