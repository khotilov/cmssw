process Reco = {
    untracked PSet configurationMetadata = {
	untracked string version = "$Revision: 1.1 $ + adding more recent tracking"
	untracked string name = "$Source: /cvs_server/repositories/CMSSW/CMSSW/IOMC/CosmicMuonGenerator/test/CosmicMuonsUndergroundTrackerDigiReco.cfg,v $"
	untracked string annotation = "cosmics in tracker: digi+reco"
    }

    # initialize  MessageLogger
    include "FWCore/MessageLogger/data/MessageLogger.cfi"
    
    # Monitor
    untracked PSet options = {
	untracked bool wantSummary = true
    }

#    service = RandomNumberGeneratorService {
#	PSet moduleSeeds = {
#	    untracked uint32 mix = 3456
#	}
#    }

    source = PoolSource {
	untracked int32 maxEvents   = -1
	untracked uint32 skipEvents = 0
	untracked vstring fileNames = {
	    "file:cosmics_sim.root"
	}
    }

#
# Includes for digi step:
#
    # Need to avoid default pixel digi, but want to run same module name siPixelDigis.
    # Therefore all following includes come (indirectly) from
    #    include "Configuration/StandardSequences/data/Simulation.cff"
    include "SimGeneral/TrackingAnalysis/data/trackingtruth.cfi"
    include "Geometry/TrackerGeometryBuilder/data/trackerGeometry.cfi"
    #include "SimTracker/SiPixelDigitizer/data/PixelDigi.cfi"
    # Accordnig to https://hypernews.cern.ch/HyperNews/CMS/get/pixelOfflineSW/92/1/1/1/1.html,
    # PixelDigi.cfi replaced by the following to add untracked parameter
    # (Take care: Must follow change in >CMSSW_1_3_4!):
    module siPixelDigis =  SiPixelDigitizer { 
	vstring ROUList = {
	    "TrackerHitsPixelBarrelLowTof","TrackerHitsPixelBarrelHighTof",
	    "TrackerHitsPixelEndcapLowTof","TrackerHitsPixelEndcapHighTof"}
	double ElectronPerAdc=135.0
	double ThresholdInNoiseUnits = 5.
        double TanLorentzAnglePerTesla =0.106
        int32 AddPixelInefficiency = 0	
        bool AddNoise = true
        bool AddNoisyPixels = true
        bool MissCalibrate = true
        double GainSmearing = 0.0
        double OffsetSmearing = 0.0
        double NoiseInElectrons =500.0
        bool  Alpha2Order = true
	
	# Mean tof in pixel is 30, but there is no shift possible (yet). The readout window is 
	# by default 12.5 ns. I extend here above 42.5 since I loose a lot of pixel hits
	# otherwise. Detailed studies about that postponed...
	untracked double TofCut = 70.
    }
    include "SimTracker/SiStripDigitizer/data/SiStripDigi.cfi" 
    sequence trDigi = { siPixelDigis & siStripDigis }

    include "Configuration/StandardSequences/data/MixingNoPileUp.cff" 

#
# Adjustments for digitisation:
#
    # block SiStripNoiseServiceParameters used in siStripDigis AND siStripClusters
    replace SiStripNoiseServiceParameters.PeakMode = true
    replace siStripDigis.APVpeakmode = true # for SiStripDigitizerAlgorithm/SiLinearChargeDivider
    replace siStripDigis.CouplingCostant  = {0.86,0.07}
    replace siStripDigis.CosmicDelayShift = 30.

#
# Includes for local tracker reco
#
    include "RecoLocalTracker/Configuration/data/RecoLocalTracker.cff"
    # Should be default, at least as long as we have in include 
    # SiStripClusterizer_SimData.cfi and not SiStripClusterizer_RealData.cfi:
    #    replace siStripClusters.ChannelThreshold    = 2.0
    #    replace siStripClusters.SeedThreshold       = 3.0
    #    replace siStripClusters.ClusterThreshold    = 5.0
    # Peak mode already chosen via SiStripNoiseServiceParameters.

    # no changes for pixel clustering


#
# Includes for cosmic track finding (RS not ready for cosmics at P5)
# First CosmicTF, then CTF
#
    #include "RecoTracker/TkSeedGenerator/data/CosmicSeed.cff"
    module cosmicseedfinderP5 = CosmicSeedGenerator{
	InputTag matchedRecHits = siStripMatchedRecHits:matchedRecHit
	InputTag rphirecHits    = siStripMatchedRecHits:rphiRecHit
	InputTag stereorecHits  = siStripMatchedRecHits:stereoRecHit
	double ptMin=0.9
	double originRadius=150
	double originHalfLength=90
	double originZPosition=0
	double SeedPt = 1.0	
	string TTRHBuilder        =  "WithTrackAngle"	
	untracked string GeometricStructure  = "STANDARD" //other choice: TIBD+
	untracked string HitsForSeeds = "triplets" # default is pairs
    }
    include "RecoTracker/SingleTrackPattern/data/CosmicTrackFinder.cff"
    replace cosmictrackfinder.GeometricStructure = "STANDARD"
    replace cosmictrackfinder.debug = false
    replace cosmictrackfinder.cosmicSeeds = cosmicseedfinderP5
    sequence cosmics = {cosmicseedfinderP5, cosmictrackfinder}

    include "RecoTracker/SpecialSeedGenerators/data/CombinatorialSeedGeneratorForCosmicsP5.cff"
    include "RecoTracker/CkfPattern/data/CkfTrackCandidatesP5.cff"

#    include "RecoTracker/TrackProducer/data/CTFFinalFitWithMaterialP5.cff"
    module ctfWithMaterialTracksP5 = ctfWithMaterialTracks from "RecoTracker/TrackProducer/data/CTFFinalFitWithMaterial.cfi"
    replace ctfWithMaterialTracksP5.src = "ckfTrackCandidatesP5"

    sequence ckfCosmicsP5 = {
        combinatorialcosmicseedfinderP5, ckfTrackCandidatesP5, ctfWithMaterialTracksP5
    }

#
# Event output
#
    include "Configuration/EventContent/data/EventContent.cff"
    replace FEVTSIMEventContent.outputCommands += "keep *_source_*_*"
    replace FEVTSIMEventContent.outputCommands += "keep *_cosmicseedfinder_*_*"
    replace FEVTSIMEventContent.outputCommands += "keep *_cosmictrackfinder_*_*"
    replace FEVTSIMEventContent.outputCommands += "keep *_*P5*_*_*"
    replace FEVTSIMEventContent.outputCommands += "drop TrajectorysrecoTracksushortedmOneToOneedmAssociationMap_*_*_*"
    module FEVTSIM = PoolOutputModule { 
	using FEVTSIMEventContent
	untracked string fileName = 
	    "file:cosmics_sim_digi_reco_135patched.root"
        untracked PSet datasets = {
	    untracked PSet dataset1 = {
		untracked string dataTier = "GEN-SIM-DIGI-RECO" 
	    }
        }
    }
    
    #
    # Order of execution: Restrict to tracker.
    #
    endpath p  = {
	mix, trDigi, trackingtruth, # digi only tracker
	trackerlocalreco, # local reco only in tracker
	cosmics, ckfCosmicsP5, # cosmic track finder and ckf for cosmics
	FEVTSIM}
}
