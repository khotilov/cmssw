#!/usr/bin/env perl
#
# $Id: checkdeps,v 1.5 2008/03/12 17:59:09 dlange Exp $
#
# Created by: David Lange
#             LLNL
#             12 September 207
#
use strict;
use warnings;
use Getopt::Long;
use Cwd;

#Idea: diff checked out packages.
#     looking for changed headers
#     find all packages that depend on those headers
#     print that list.

#if any argument, print help and exit 

my $runAddpkg=0;
 
foreach my $arg (@ARGV) {
    if ( $arg eq "-a" ) {
	$runAddpkg=1;
    }
    else{
	print "checkdeps:\n";
	print "   Utility to check your local development area against the CMSSW release.\n";
	print "   Any modified header files are found and the package dependencies of \n";
	print "   these files will be returned. addpkg-ing these packages and rebuilding them\n";
	print "   should provide a full and consistent build.\n";
	print "\nUsage: \n";
	print "   -a will checkout the packages into your development area (done by addpkg)\n\n";
	exit;
    }
}

if ( $ENV{'LOCALRT'} eq "" ) {
    print "Please setup the scram runtime environment before running this script\n";
    exit;
}

if ( $ENV{'CMSSW_RELEASE_BASE'} eq "" ) {
    print "Please setup the scram runtime environment before running this script\n";
    exit;
}

if ( $ENV{'CVSROOT'} eq "" ) {
    print "Please setup the CVS environment before running this script (likely |project CMSSW|)\n";
    exit;
}

if ( !(-e "$ENV{'CMSSW_RELEASE_BASE'}/etc/dependencies/usedby.out.gz") ) {
    print "This release appears not to support the functionality of this script (170pre4 and higher). Sorry\n";
    exit;
}

open(F1,"gunzip -c $ENV{'CMSSW_RELEASE_BASE'}/etc/dependencies/usedby.out |");
     


chdir("$ENV{'LOCALRT'}/src");
my @f1 = `ls`;
my $maindir=cwd;

my @subsys;
my @packages;

# Get the list of packages
for my $f (@f1) {
  chomp($f);
  chdir("$maindir");
  if( -d $f && ($f ne "CVS") ) { 
    push @subsys, $f;
    chdir("$f");
    # list of packages in subystem
    my @f2 = `ls`;
    for my $ff (@f2) {
      chomp($ff);
      if(-d $ff && ($ff ne "CVS") ) {
        my $pack = "$f/$ff";
        push @packages, "$pack";
      }
    }
  }

}

#check that addpkg is ok...
my $isaddpkg=`which addpkg`;
if ( $isaddpkg =~ /Command not found/) {
    print "This script relies on addpkg, which appears not to be in your path\n";
    print "Perhaps something is wrong with this release or your run time\n";
    print "environment is not set correctly?\n";
    return;
}

my @changedFiles;

foreach my $package (@packages) {
    next if ($package =~/^UserCode.*/);
    chdir("$maindir");
    chdir("$package");
    my $reltag=`addpkg -q $package`;
    my @sp1=split(' ',$reltag);
    $reltag=$sp1[1];
    my $diffs=`cvs -q -n update -r $reltag`;
    my @diffs=split('\n',$diffs);
    foreach my $diff (@diffs) {
	if ( ($diff =~/^M/) || ($diff =~/^U/) || ($diff =~/^R/) ) {
	    my @sp2=split(' ', $diff);
	    push(@changedFiles,"$package/$sp2[1]");
	}
    }
}

my %vals;

while  (<F1>) { 
    my $line=$_;
    chomp($line);
    my @sp1=split(' ',$line,2);
    $vals{$sp1[0]}=$sp1[1];
}

my @recompileList;
foreach my $file (@changedFiles) {
    next if (!(exists $vals{$file}));
    my @sp3=split(' ',$vals{$file});
    foreach my $dep (@sp3) {
	my @sp4=split('/',$dep);
	my $recompile="$sp4[0]/$sp4[1]";
	if (!(grep {$_ eq $recompile} @recompileList)) {
	    if (!(grep {$_ eq $recompile} @packages)) {
		push(@recompileList,$recompile);
	    }
	}
    }
}

my @t=sort(@recompileList);
my $len=scalar(@t);
if ( $runAddpkg == 0 ) {
    print "Packages to check out and compile:\n";
}
else{
    print "Checking out these packages\n";
}

if ( $len > 0 ) {
    foreach my $i (@t) {
	print "$i\n";
    }
    if ( $runAddpkg == 1 ) {
	foreach my $i (@t) {
	    system("addpkg $i");
	}
    }
}
else{
    print "None\n";
}
close F1;
