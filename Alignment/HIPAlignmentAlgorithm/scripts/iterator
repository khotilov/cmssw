#!/bin/tcsh

set iter = $1
set odir = $2
set data = (`cat $3`)
set jobs = $#data

cp test/common.cff $odir/

## Set up config file for each alignment job

if ($jobs > 0) then
    @ j = 0 # job index

    foreach file ($data)
	@ j++

	mkdir $odir/job$j

	replace "<FILE>" $file "<PATH>" $PWD/$odir/job$j < test/align.tpl > $odir/job$j/align.cfg
    end
endif

## Set up config file for collector job

mkdir $odir/main
replace "<PATH>" $PWD/$odir "<JOBS>" $jobs < test/collect.tpl > $odir/main/collect.cfg

## Set up config file for iteration 0

replace "<PATH>" $PWD/$odir < test/initial.tpl > $odir/main/initial.cfg

cmsRun $odir/main/initial.cfg >& $odir/main/initial

## Submit jobs and iterate

scripts/submitJobs $iter $odir
