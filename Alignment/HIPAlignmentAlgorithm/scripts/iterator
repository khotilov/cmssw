#!/bin/tcsh

set iter = $1
set odir = $2

cp test/common.cff $odir/

## Set up config file for each alignment job

@ j = 0 # job index

foreach data (`ls $3`)
  set skim = `basename $data .dat`

  foreach file (`cat $data`)
    @ j++

    mkdir $odir/job$j
    replace "<FILE>" $file "<PATH>" $PWD/$odir/job$j "<SKIM>" $skim < test/align.tpl > $odir/job$j/align.cfg
  end
end

## Set up config file for collector job

mkdir $odir/main
replace "<PATH>" $PWD/$odir "<JOBS>" $j < test/collect.tpl > $odir/main/collect.cfg

## Set up config file for iteration 0

replace "<PATH>" $PWD/$odir < test/initial.tpl > $odir/main/initial.cfg

cmsRun $odir/main/initial.cfg >& $odir/main/initial

## Submit jobs and iterate

scripts/submitJobs $iter $odir
