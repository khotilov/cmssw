#
# CSA06 Skim Reco for Zee to be run at T1
# Filter Z events in suitable mass range and requires pt and eta theshold for electrons
# Then produces for selected events
# a) AlcaReco for calibration
# b) RECO events
# Created by Paolo Meridiani
# Tested on 12/10/2006

process ZeeSkim= {
    include "Configuration/EventContent/data/RECOSIMOutput.cff"
    
    untracked PSet options = {
	untracked bool wantSummary = true  # default is false
    }
    
    ### keep the logging output to a nice level ###
    include "FWCore/MessageLogger/data/MessageLogger.cfi"
    
    service = AdaptorConfig {}
    
    source = PoolSource {
	untracked vstring fileNames =
	{
	    '/store/CSA06/CSA06-103-os-EWKSoup-0/RECO/CMSSW_1_0_3-RECO-Hcc50df9a16717df4367a80c47fe190b8/1010/08979E3D-8658-DB11-9D5A-0002B3D8E65F.root'
	}
	untracked int32 maxEvents = -1
	untracked uint32 debugVerbosity = 1
	untracked bool   debugFlag     = true
  }

    # sequence to make pixel-based electrons
    # this is needed to fix the wrong electrons from 1_0_3 
    ############ initialize magnetic field #########################
    include "MagneticField/Engine/data/volumeBasedMagneticField.cfi"
    
    ############### initialize geometry #####################
    include "Geometry/CMSCommonData/data/cmsIdealGeometryXML.cfi"
    include "Geometry/TrackerGeometryBuilder/data/trackerGeometry.cfi"
    include "Geometry/TrackerNumberingBuilder/data/trackerNumberingGeometry.cfi"
    include "RecoTracker/GeometryESProducer/data/TrackerRecoGeometryESProducer.cfi"
    
    ### ESProducers needed for tracking
    include "RecoTracker/TransientTrackingRecHit/data/TransientTrackingRecHitBuilder.cfi"
    include "TrackingTools/KalmanUpdators/data/KFUpdatorESProducer.cfi"
    include "TrackingTools/TrackFitters/data/KFTrajectoryFitterESProducer.cfi"
    include "TrackingTools/TrackFitters/data/KFTrajectorySmootherESProducer.cfi"
    include "TrackingTools/TrackFitters/data/KFFittingSmootherESProducer.cfi" 
    include "TrackingTools/MaterialEffects/data/MaterialPropagator.cfi"
    include "TrackingTools/MaterialEffects/data/OppositeMaterialPropagator.cfi"
    include "RecoLocalTracker/SiPixelRecHits/data/PixelCPEParmError.cfi"
    include "RecoLocalTracker/SiStripRecHitConverter/data/StripCPEfromTrackAngle.cfi"
    include "RecoLocalTracker/SiStripRecHitConverter/data/SiStripRecHitMatcher.cfi"
    
    # modules to make seeds and electrons
    include "RecoEgamma/EgammaElectronProducers/data/egammaChi2MeasurementEstimatorESProducer.cfi"
    #    include "RecoEgamma/EgammaElectronProducers/data/electronPixelSeeds.cfi"
    
    module pixelMatchElectronsFixed = PixelMatchElectronProducer {
	
	string SeedProducer         = "electronPixelSeeds"
	double ptCut                = 0.9
	int32  maxCand              = 5
	int32  maxLostHit           = 1
	int32  maxConsecLostHit     = 1
	double lostHitPenalty       = 30.
	bool   intermediateCleaning = true
	#int32  minimumNumberOfHits  = 5
	int32  minimumNumberOfHits  = 3
	bool   alwaysUseInvalidHits = true
	bool   seedCleaning         = false
	string TTRHBuilder          = "WithTrackAngle"
	
	# nested parameter set for MeasurementTracker
	PSet MeasurementTrackerParameters = {
	    string PixelCPE = "PixelCPEfromTrackAngle"
	    string StripCPE = "StripCPEfromTrackAngle"
	    double NSigmaInside =3
	}
	
	# nested parameter set for TransientInitialStateEstimator
	PSet TransientInitialStateEstimatorParameters = {
	    string propagatorAlongTISE    = "PropagatorWithMaterial"
	    string propagatorOppositeTISE = "PropagatorWithMaterialOpposite"
	}
	
	double maxEOverP = 3.
	double maxHOverE = 0.1
	double maxDeltaEta = 0.02
	double maxDeltaPhi = 0.1
	
	# needed for CkfTrajectoryBuilder
	string propagatorAlong      = "PropagatorWithMaterial"
	string propagatorOpposite   = "PropagatorWithMaterialOpposite"
	string updator              = "KFUpdator"
	string estimator            = "egammaChi2"
	
    }

    ###########################################

    module zeeFilter = MCZll
    {
	untracked double zMassMin = 50.
	untracked double zMassMax = 130.
	untracked double leptonPtMin = 5.
	untracked double leptonPtMax = 999999.
	untracked double leptonEtaMin = 0.
	untracked double leptonEtaMax = 2.7
    }

    module electronFilter = EtaPtMinElectronSelector
    {
	InputTag src = pixelMatchElectronsFixed
	bool filter = true
	double ptMin = 5.0
	double etaMin = -2.7
	double etaMax = 2.7
    }

    include "Calibration/EcalAlCaRecoProducers/data/alCaIsolatedElectrons.cfi"

    path p1={ zeeFilter }
    path p2={ zeeFilter, pixelMatchElectronsFixed , electronFilter ,  alCaIsolatedElectrons }


    module ALCARECO1 = PoolOutputModule
    {
	untracked string fileName = "eg_alCaElectrons.root" 
        untracked string filterName = "eg_alcastreamElectron_ZeeFilter"
        untracked string dataTier = "ALCARECO"
	untracked vstring outputCommands = 
	{
	    "drop  *",
	    "keep  TrackCandidates_pixelMatchElectrons_*_*",
            "keep  *_electronFilter_*_*",
            "keep  *_alCaIsolatedElectrons_*_*",
	    "keep  *_zeeFilter_*_*"
	}
	untracked PSet SelectEvents = 
	{
	    vstring SelectEvents = { "p1" }
	}
    }

    block fixedElectrons = {
	untracked vstring outputCommands = {
	    "keep *_pixelMatchElectronsFixed_*_*",
	    "drop *_pixelMatchElectrons_*_*"
#	    "keep *_electronPixelSeeds_*_*"
	}
    }

   replace RECOSIMOutput.outputCommands += fixedElectrons.outputCommands

    module RECOSIM1 = PoolOutputModule
    {
	untracked string fileName = "eg_skimmedEleFullReco.root" 
        untracked string filterName = "eg_ZeeFilter"
        untracked string dataTier = "RECOSIM"
	using RECOSIMOutput
	untracked PSet SelectEvents = 
	{
	    vstring SelectEvents = { "p1" }
	}
    }

   endpath outpathAlca = { ALCARECO1 }
   endpath outpathFull = { RECOSIM1 }
}
